<!DOCTYPE html>
<html>
<body>
<svg></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script>
    let sameLocation = false;
    const width = 960;
    const height = 500;
    const config = {
        speed: 0.035,
        verticalTilt: -30,
        horizontalTilt: 0,
    };

    let locations = [{    "ip": "62.240.25.229",    "hostname": "dynamic-62-240-25-229.cpe.sn.co.rs",    "city": "Ripanj",    "region": "Central Serbia",    "country": "RS",    "latitude": "44.6386",    "longitude": "20.5214",    "org": "AS41937 TELEKOM SRBIJA a.d.",    "postal": "11232",    "timezone": "Europe/Belgrade",    "readme": "https://ipinfo.io/missingauth"}];

    fetch('https://ipinfo.io/json')
        .then((response) => response.json())
        .then((data) => {
            const { loc, region } = data;
            const [latitude, longitude] = loc.split(',');
            if (locations[0].region === region) {
                sameLocation = true;
            } else {
                sameLocation = false;
                locations.push({
                    latitude,
                    longitude,
                    region,
                });
            }
            setup();
        }).catch((error) => {
        sameLocation = false;
        console.log(error);
        setup();
    });

    const svg = d3.select('svg').attr('width', width).attr('height', height);
    const markerGroup = svg.append('g');
    const textGroup = svg.append('g');
    const projection = d3.geoOrthographic();
    const path = d3.geoPath().projection(projection);

    function setup() {
        drawGlobe();
        drawGraticule();
        enableRotation();
    }

    function drawGlobe() {
        d3.queue()
            .defer(
                d3.json,
                'https://gist.githubusercontent.com/mbostock/4090846/raw/d534aba169207548a8a3d670c9c2cc719ff05c47/world-110m.json'
            )
            .await((error, worldData, locationData) => {
                svg
                    .selectAll('.segment')
                    .data(topojson.feature(worldData, worldData.objects.countries).features)
                    .enter()
                    .append('path')
                    .attr('class', 'segment')
                    .attr('d', path)
                    .style('stroke', '#' + Math.floor(Math.random() * 16777215).toString(16))
                    .style('stroke-width', '1px')
                    .style('fill', (d, i) => '#' + Math.floor(Math.random() * 16777215).toString(16))
                    .style('opacity', '.6');
            });
    }

    function drawGraticule() {
        const graticule = d3.geoGraticule().step([1, 1]);
        svg.append('path').datum(graticule).attr('class', 'graticule').attr('d', path).style('fill', '#fff').style('stroke', '#ccc');
    }

    function enableRotation() {
        d3.interval((elapsed) => {
            projection.rotate([config.speed * elapsed - 12000000000000000, config.verticalTilt, config.horizontalTilt]);
            svg.selectAll('path').attr('d', path);
            drawMarkers();
        },50)
    }

    function drawMarkers(sameLocation) {
        const markers = markerGroup.selectAll('circle').data(locations)
        markers
            .enter()
            .append('circle')
            .merge(markers)
            .attr('cx', d => projection([d.longitude, d.latitude])[0])
            .attr('cy', d => projection([d.longitude, d.latitude])[1])
            .attr('fill', '#000')
            .attr('r', 7);

        markerGroup.each(function () {
            this.parentNode.appendChild(this);
        });

        const text = textGroup.selectAll('text').data(locations)
        text.enter()
            .append('text')
            .merge(text)
            .attr("font-size", "14px")
            .attr("fill", '#000')
            .attr("font-family", 'Helvetica Neue')
            .attr("font-weight", '600')
            .attr('x', (d) => projection([d.longitude, d.latitude])[0]+15)
            .attr('y', (d) => projection([d.longitude, d.latitude])[1])
            .text((d) => sameLocation ? 'We are in the same region' : d.region)

        textGroup.each(function () {
            this.parentNode.appendChild(this);
        });
    }
</script>
</body>
</html>
